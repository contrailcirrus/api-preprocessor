# api-preprocessor

## Overview

## Behavior

## Environment Variables
The following environment variables are expected for production and development environments.

### Prod

| name                             |                                               value                                                |                              description                               |
|:---------------------------------|:--------------------------------------------------------------------------------------------------:|:----------------------------------------------------------------------:|
| SOURCE_PATH                      |                      gs://contrails-301217-ecmwf-hres-forecast-v2-short-term                       |     fully-qualified file path for HRES pressure-level zarr stores      |
| SINK_PATH                        |                               gs://contrails-301217-api-preprocessor                               |    fully-qualified file path prefix for writing output data assets     |
| API_PREPROCESSOR_SUBSCRIPTION_ID |                    projects/contrails-301217/subscriptions/api-preprocessor-sub                    | subscription for api-preprocessor jobs (generated by the hres-etl svc) |
| LOG_LEVEL                        |                                              WARNING                                               |                  log level for service in production                   |

### Dev

| name                             |                              value                               |                              description                               |
|:---------------------------------|:----------------------------------------------------------------:|:----------------------------------------------------------------------:|
| SOURCE_PATH                      |   gs://contrails-301217-ecmwf-hres-forecast-v2-short-term-dev    |     fully-qualified file path for HRES pressure-level zarr stores      |
| SINK_PATH                        |            gs://contrails-301217-api-preprocessor-dev            |    fully-qualified file path prefix for writing output data assets     |
| API_PREPROCESSOR_SUBSCRIPTION_ID | projects/contrails-301217/subscriptions/api-preprocessor-sub-dev | subscription for api-preprocessor jobs (generated by the hres-etl svc) |
| LOG_LEVEL                        |                               INFO                               |                  log level for service in development                  |

## Local Development
### Testing with dev CloudRun instance

Proxy your local machine to the CloudRun gateway 
(this both proxies and shims w/ an auth interceptor between your local machine and GCP):
```bash
gcloud run services proxy api-preprocessor-dev
```

Hit the proxied localhost address, as you would the remote address.
```bash
curl -X POST -H "Content-Type: application/json" -d '{}' http://localhost:8080/run
```


## Deploy